<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>오늘의 급식 평점</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, increment
    } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCuOQ3EYAMl5IRwNXhc4mcf9RgpoURnOgA",
      authDomain: "mealrate-b757a.firebaseapp.com",
      projectId: "mealrate-b757a",
      storageBucket: "mealrate-b757a.appspot.com",
      messagingSenderId: "427937261811",
      appId: "1:427937261811:web:f70ced07ba5e41f9bcef86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userId = localStorage.getItem('meal-rating-id') || crypto.randomUUID();
    localStorage.setItem('meal-rating-id', userId);

    const mealBox = document.getElementById('meal-box');
    const schoolBox = document.getElementById('school-box');
    const regionBox = document.getElementById('region-box');
    const changeSchoolBtn = document.getElementById('change-school');

    const ATPT_CODES = {
      '서울특별시': 'B10',
      '부산광역시': 'C10',
      '대구광역시': 'D10',
      '인천광역시': 'E10',
      '광주광역시': 'F10',
      '대전광역시': 'G10',
      '울산광역시': 'H10',
      '세종특별자치시': 'I10',
      '경기도': 'J10',
      '강원도': 'K10',
      '충청북도': 'M10',
      '충청남도': 'N10',
      '전라북도': 'P10',
      '전라남도': 'Q10',
      '경상북도': 'R10',
      '경상남도': 'S10',
      '제주특별자치도': 'T10'
    };

    async function selectSchoolFlow() {
      const saved = JSON.parse(localStorage.getItem('school-info'));
      if (saved) {
        schoolBox.textContent = saved.schoolName;
        await fetchMealData(saved);
        return;
      }
      regionBox.classList.remove('hidden');
    }

    document.getElementById('region-select-btn').addEventListener('click', async () => {
      const region = document.getElementById('region').value;
      const keyword = document.getElementById('school').value;
      if (!region || !keyword) return alert('시도와 학교명을 입력해주세요');
      const atptCode = ATPT_CODES[region];
      const url = `https://open.neis.go.kr/hub/schoolInfo?KEY=12524cf433f544708e5fdec54b0ba13d&Type=json&ATPT_OFCDC_SC_CODE=${atptCode}&SCHUL_NM=${encodeURIComponent(keyword)}`;
      const res = await fetch(url);
      const data = await res.json();
      const school = data.schoolInfo?.[1]?.row?.[0];
      if (!school) return alert('학교를 찾을 수 없습니다');
      const info = {
        atpt: school.ATPT_OFCDC_SC_CODE,
        code: school.SD_SCHUL_CODE,
        schoolName: school.SCHUL_NM
      };
      localStorage.setItem('school-info', JSON.stringify(info));
      schoolBox.textContent = info.schoolName;
      regionBox.classList.add('hidden');
      await fetchMealData(info);
    });

    changeSchoolBtn.addEventListener('click', () => {
      localStorage.removeItem('school-info');
      location.reload();
    });

    async function fetchMealData(info) {
      const today = new Date().toLocaleDateString('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).replace(/\. /g, '').replace('.', '');
      const url = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=12524cf433f544708e5fdec54b0ba13d&Type=json&ATPT_OFCDC_SC_CODE=${info.atpt}&SD_SCHUL_CODE=${info.code}&MLSV_YMD=${today}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const meal = data.mealServiceDietInfo?.[1]?.row?.[0]?.DDISH_NM;
        mealBox.textContent = meal ? meal.replace(/<br\/?/g, '\n') : '오늘은 등록된 급식이 없습니다';
      } catch {
        mealBox.textContent = '급식 정보를 불러오는 데 실패했습니다';
      }
    }

    window.onload = selectSchoolFlow;
  </script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
  <div class="max-w-md w-full bg-white p-6 rounded-2xl shadow space-y-4">
    <div class="flex justify-between items-center">
      <h1 class="text-xl font-bold">오늘의 급식</h1>
      <button id="change-school" class="text-sm text-blue-500 underline">학교 변경</button>
    </div>
    <div id="school-box" class="text-center font-semibold text-lg"></div>
    <div id="meal-box" class="bg-gray-100 p-4 rounded-xl border text-center whitespace-pre-wrap">급식 정보를 불러오는 중...</div>

    <div id="region-box" class="hidden space-y-2">
      <select id="region" class="w-full border rounded-xl p-2">
        <option value="">시도 선택</option>
        ${Object.keys(ATPT_CODES).map(r => `<option>${r}</option>`).join('')}
      </select>
      <input id="school" class="w-full border rounded-xl p-2" placeholder="학교명 입력">
      <button id="region-select-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-xl">학교 선택</button>
    </div>
  </div>
</body>
</html>
